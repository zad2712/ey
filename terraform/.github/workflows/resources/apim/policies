
####### All APIs
####### Front Door ID needs to be created as a named value variable in the APIM

<!--
    IMPORTANT:
    - Policy elements can appear only within the <inbound>, <outbound>, <backend> section elements.
    - Only the <forward-request> policy element can appear within the <backend> section element.
    - To apply a policy to the incoming request (before it is forwarded to the backend service), place a corresponding policy element within the <inbound> section element.
    - To apply a policy to the outgoing response (before it is sent back to the caller), place a corresponding policy element within the <outbound> section element.
    - To add a policy position the cursor at the desired insertion point and click on the round button associated with the policy.
    - To remove a policy, delete the corresponding policy statement from the policy document.
    - Policies are applied in the order of their appearance, from the top down.
-->
<policies>
    <!-- 
        This Azure API Management (APIM) policy file defines security and processing rules for the API.
        The policies are executed in the order they appear, from top to bottom within each section.
    -->
    <inbound>
        <check-header name="X-Azure-FDID" failed-check-httpcode="401" failed-check-error-message="Unauthorized connection. Front Door Only." ignore-case="false">
            <value>{{FrontDoorId}}</value>
        </check-header>
    </inbound>
    <backend>
        <!-- 
            Backend request forwarding
            After the request passes all inbound policies, it is forwarded to the backend service.
            No additional transformation is applied to the request at this stage.
        -->
        <forward-request />
    </backend>
    <outbound>
        <!-- 
            Outbound processing section
            Policies in this section are executed after receiving the response from the backend service.
            This section can be used for response manipulation, caching, or adding response headers.
            Currently no policies are defined in this section.
        -->
    </outbound>
    <on-error>
        <!-- 
            Error handling section
            Policies in this section are executed if an error occurs during the processing of the request.
            This section can be used for custom error handling, logging, or transforming error responses.
            Currently no policies are defined in this section.
        -->
    </on-error>
</policies>

####### Notice API Policy
####### Allowed Origins are examples, update with the appropriate ones depending on the environment and instance

<!--
    IMPORTANT:
    - Policy elements can appear only within the <inbound>, <outbound>, <backend> section elements.
    - To apply a policy to the incoming request (before it is forwarded to the backend service), place a corresponding policy element within the <inbound> section element.
    - To apply a policy to the outgoing response (before it is sent back to the caller), place a corresponding policy element within the <outbound> section element.
    - To add a policy, place the cursor at the desired insertion point and select a policy from the sidebar.
    - To remove a policy, delete the corresponding policy statement from the policy document.
    - Position the <base> element within a section element to inherit all policies from the corresponding section element in the enclosing scope.
    - Remove the <base> element to prevent inheriting policies from the corresponding section element in the enclosing scope.
    - Policies are applied in the order of their appearance, from the top down.
    - Comments within policy elements are not supported and may disappear. Place your comments between policy elements or at a higher level scope.
-->
<policies>
    <inbound>
        <cors allow-credentials="true">
            <allowed-origins>
                <origin>https://eyx-uat-lab-use.ey.com</origin>
                <origin>https://apim.eyx-uat-lab-use.ey.com</origin>
                <origin>https://eyq-uat2.eyfabric.ey.com/</origin>
            </allowed-origins>
            <allowed-methods preflight-result-max-age="300">
                <method>*</method>
            </allowed-methods>
            <allowed-headers>
                <header>*</header>
            </allowed-headers>
            <expose-headers>
                <header>*</header>
            </expose-headers>
        </cors>
        <rate-limit-by-key calls="1000" renewal-period="60" counter-key="@(context.Request.Headers.GetValueOrDefault("Authorization","").AsJwt()?.Subject)" />
        <base />
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>




####### Main API Policy
####### Allowed Origins are examples, update with the appropriate ones depending on the environment and instance

<!--
    IMPORTANT:
    - Policy elements can appear only within the <inbound>, <outbound>, <backend> section elements.
    - To apply a policy to the incoming request (before it is forwarded to the backend service), place a corresponding policy element within the <inbound> section element.
    - To apply a policy to the outgoing response (before it is sent back to the caller), place a corresponding policy element within the <outbound> section element.
    - To add a policy, place the cursor at the desired insertion point and select a policy from the sidebar.
    - To remove a policy, delete the corresponding policy statement from the policy document.
    - Position the <base> element within a section element to inherit all policies from the corresponding section element in the enclosing scope.
    - Remove the <base> element to prevent inheriting policies from the corresponding section element in the enclosing scope.
    - Policies are applied in the order of their appearance, from the top down.
    - Comments within policy elements are not supported and may disappear. Place your comments between policy elements or at a higher level scope.
-->
<policies>
    <inbound>
        <cors allow-credentials="true">
            <allowed-origins>
                <origin>https://eyx-uat-lab-use.ey.com</origin>
                <origin>https://apim.eyx-uat-lab-use.ey.com</origin>
                <origin>https://eyq-uat2.eyfabric.ey.com/</origin>
            </allowed-origins>
            <allowed-methods preflight-result-max-age="300">
                <method>*</method>
            </allowed-methods>
            <allowed-headers>
                <header>*</header>
            </allowed-headers>
            <expose-headers>
                <header>*</header>
            </expose-headers>
        </cors>
        <rate-limit-by-key calls="1000" renewal-period="60" counter-key="@(context.Request.Headers.GetValueOrDefault("Authorization","").AsJwt()?.Subject)" />
        <base />
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>


####### Negotiation Rule
####### Allowed Origins are examples, update with the appropriate ones depending on the environment and instance

<!--
    - Policies are applied in the order they appear.
    - Position <base/> inside a section to inherit policies from the outer scope.
    - Comments within policies are not preserved.
-->
<!-- Add policies as children to the <inbound>, <outbound>, <backend>, and <on-error> elements -->
<policies>
    <!-- Throttle, authorize, validate, cache, or transform the requests -->
    <inbound>
        <base />
        <cors allow-credentials="true">
            <allowed-origins>
                <origin>https://eyx-uat-lab-use.ey.com/</origin>
                <origin>https://eyq-uat2.eyfabric.ey.com/</origin>
            </allowed-origins>
            <allowed-methods preflight-result-max-age="3500">
                <method>*</method>
            </allowed-methods>
            <allowed-headers>
                <header>*</header>
            </allowed-headers>
        </cors>
    </inbound>
    <!-- Control if and how the requests are forwarded to services  -->
    <backend>
        <base />
    </backend>
    <!-- Customize the responses -->
    <outbound>
        <base />
    </outbound>
    <!-- Handle exceptions and customize error responses  -->
    <on-error>
        <base />
    </on-error>
</policies>


####### Openai API
####### Backend URL is an example. Update with the correct value for each Environment and Instance

<policies>
    <inbound>
        <base />
        <!-- Reused the following policy: https://github.com/Azure/enterprise-azureai/blob/main/infra/modules/apim/policies/api_policy_openai.xml -->
        <choose>
            <when condition="@(context.Request.Body.As&lt;JObject&gt;(true)[&quot;stream&quot;] != null &amp;&amp; context.Request.Body.As&lt;JObject&gt;(true)[&quot;stream&quot;].Type != JTokenType.Null)">
                <set-variable name="isStream" value="@{
                    var content = (context.Request.Body?.As&lt;JObject&gt;(true));
                    string streamValue = content[&quot;stream&quot;].ToString();
                    return streamValue;
                }" />
            </when>
        </choose>
        <set-backend-service base-url="https://useuaoi0xcaoa01.openai.azure.com/openai" />
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
        <set-header name="x-ms-stream" exists-action="override">
            <value>@{
                    return context.Variables.GetValueOrDefault&lt;string&gt;("isStream","false").Equals("true", StringComparison.OrdinalIgnoreCase).ToString();
                }</value>
        </set-header>
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>

