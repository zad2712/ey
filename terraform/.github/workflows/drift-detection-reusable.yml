name: Drift Detection - Reusable Workflow

on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
      layer:
        type: string
        required: true
      env_tfvars_folder:
        type: string
        required: true
      tfvars_file:
        type: string
        required: true
      runs_on:
        type: string
        required: false
        default: 'ubuntu-latest'

jobs:
  detect-drift:
    name: ðŸ” Drift (${{ inputs.layer }}-${{ inputs.environment }})
    runs-on: ${{ inputs.runs_on && fromJson(inputs.runs_on) || 'ubuntu-latest' }}
    environment: ${{ inputs.environment }}
    
    steps:
      # Step 1: Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Login to Azure
      - name: 'Login to Azure'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      # Step 3: Set up terraform
      - name: Setup terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      # Step 4: replace vars
      - name: Replace placeholders in provider.tf
        run: |
          cd ./terraform/layers/${{ inputs.layer }}
          sed -i 's|${SUBSCRIPTION_ID}|${{ secrets.AZURE_SUBSCRIPTION_ID }}|g' provider.tf
          sed -i 's|${RESOURCE_GROUP_NAME}|${{ vars.RESOURCE_GROUP_NAME }}|g' provider.tf
          sed -i 's|${STORAGE_ACCOUNT_NAME}|${{ vars.STORAGE_ACCOUNT_NAME }}|g' provider.tf
          sed -i 's|${TF_STATE_PATH}|${{ inputs.environment }}/|g' provider.tf
          sed -i 's|${TENANT_ID}|${{ secrets.AZURE_TENANT_ID }}|g' provider.tf
          
          if [[ "${{ inputs.environment }}" == "dev1" || "${{ inputs.environment }}" == "dev2" || "${{ inputs.environment }}" == "dev3" ]]; then
            sed -i 's|\${BACKEND_SUBSCRIPTION_ID}|${{ secrets.BACKEND_SUBSCRIPTION_ID }}|g' provider.tf
          else
            sed -i 's|\${BACKEND_SUBSCRIPTION_ID}|${{ secrets.AZURE_SUBSCRIPTION_ID }}|g' provider.tf
          fi

      # Step 5: Terraform init
      - name: Terraform init
        run: |
          cd ./terraform/layers/${{ inputs.layer }}
          terraform init
      
      # Step 6: Terraform plan for drift detection
      - name: Terraform plan for drift detection
        working-directory: terraform/layers/${{ inputs.layer }}
        id: drift-check
        run: |
          echo "ðŸ” Checking for configuration drift..."
          echo "ðŸ“ Layer: ${{ inputs.layer }}"
          echo "ðŸŒ Environment: ${{ inputs.environment }}"
          echo "ðŸ“„ Tfvars file: ${{ inputs.tfvars_file }}"
          
          # Run plan to detect drift (capture exit code)
          set +e
          terraform plan \
            -detailed-exitcode \
            -out=drift-plan \
            -var-file="environments/${{ inputs.tfvars_file }}" \
            > plan-output.txt 2>&1
          
          PLAN_EXIT_CODE=$?
          set -e
          
          # Exit codes: 0 = no changes, 1 = error, 2 = changes detected
          case $PLAN_EXIT_CODE in
            0)
              echo "drift_status=no-drift" >> $GITHUB_OUTPUT
              echo "âœ… No drift detected"
              exit 0
              ;;
            1)
              echo "drift_status=error" >> $GITHUB_OUTPUT
              echo "âŒ Error during drift detection"
              cat plan-output.txt
              exit 1
              ;;
            2)
              echo "drift_status=drift-detected" >> $GITHUB_OUTPUT
              echo "âš ï¸ Configuration drift detected!"
              
              # Count changes
              CHANGES=$(grep -E "Plan:|# " plan-output.txt | head -10 || echo "No change summary found")
              echo "Changes summary:"
              echo "$CHANGES"
              exit 0
              ;;
          esac
      
      - name: ðŸ“Š Parse Drift Details
        working-directory: terraform/layers/${{ inputs.layer }}
        if: steps.drift-check.outputs.drift_status == 'drift-detected'
        run: |
          echo "ðŸ“Š Analyzing drift details..."
          
          # Extract change summary
          ADD_COUNT=$(grep -c "will be created" plan-output.txt 2>/dev/null || true)
          CHANGE_COUNT=$(grep -c "will be updated" plan-output.txt 2>/dev/null || true)
          DESTROY_COUNT=$(grep -c "will be destroyed" plan-output.txt 2>/dev/null || true)
          
          # Ensure counts are set (default to 0 if empty)
          ADD_COUNT=${ADD_COUNT:-0}
          CHANGE_COUNT=${CHANGE_COUNT:-0}
          DESTROY_COUNT=${DESTROY_COUNT:-0}
          
          # Build the report
          echo "# âš ï¸ Configuration Drift Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Environment and Layer Info
          echo "### ðŸ“‹ Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Layer** | \`${{ inputs.layer }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Config File** | \`${{ inputs.tfvars_file }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Detection Time** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Changes Overview
          echo "### ðŸ“Š Changes Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Change Type | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resources to Create | $ADD_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| Resources to Modify | $CHANGE_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| Resources to Delete | $DESTROY_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract and show affected resources
          echo "### ðŸŽ¯ Affected Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Resources to be created
          if [ "$ADD_COUNT" -gt 0 ]; then
            echo "#### âž• Resources to Create ($ADD_COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep "will be created" plan-output.txt | sed 's/^[[:space:]]*//' | head -20 >> $GITHUB_STEP_SUMMARY || echo "No details available" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Resources to be modified
          if [ "$CHANGE_COUNT" -gt 0 ]; then
            echo "#### ðŸ”„ Resources to Modify ($CHANGE_COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep "will be updated" plan-output.txt | sed 's/^[[:space:]]*//' | head -20 >> $GITHUB_STEP_SUMMARY || echo "No details available" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Resources to be destroyed
          if [ "$DESTROY_COUNT" -gt 0 ]; then
            echo "#### âŒ Resources to Delete ($DESTROY_COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep "will be destroyed" plan-output.txt | sed 's/^[[:space:]]*//' | head -20 >> $GITHUB_STEP_SUMMARY || echo "No details available" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Action items
          echo "### ðŸ”§ Recommended Actions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. ðŸ“¥ Download the drift plan artifact from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ” Review the changes carefully to understand the drift" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ¤” Determine if drift is expected or requires action:" >> $GITHUB_STEP_SUMMARY
          echo "   - **Expected:** Update Terraform code to match infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "   - **Unexpected:** Apply Terraform to restore desired state" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸ“ Document the decision and actions taken" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Plan summary extract
          echo "### ðŸ“„ Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Click to expand full plan output (first 100 lines)</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`terraform" >> $GITHUB_STEP_SUMMARY
          head -100 plan-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ’¡ **Tip:** Full plan details are available in the uploaded artifacts" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“Š No Drift Summary
        if: steps.drift-check.outputs.drift_status == 'no-drift'
        run: |
          echo "# âœ… No Configuration Drift Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“‹ Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Layer** | \`${{ inputs.layer }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Config File** | \`${{ inputs.tfvars_file }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Detection Time** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | âœ… **No Changes Required** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŽ‰ Infrastructure State" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployed infrastructure **perfectly matches** the Terraform configuration." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ¨ No manual changes detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ¨ No configuration drift" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ¨ All resources are in the desired state" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ’š **Great job!** Your infrastructure is properly managed and in sync." >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ’¾ Upload Drift Plan
        uses: actions/upload-artifact@v4
        if: steps.drift-check.outputs.drift_status == 'drift-detected'
        with:
          name: drift-plan-${{ inputs.layer }}-${{ inputs.environment }}
          path: terraform/layers/${{ inputs.layer }}/drift-plan
          retention-days: 30
      
      - name: ðŸ“„ Upload Plan Output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: plan-output-${{ inputs.layer }}-${{ inputs.environment }}
          path: terraform/layers/${{ inputs.layer }}/plan-output.txt
          retention-days: 7
